<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MCP Gateway - Admin Panel</title>
    <link rel="stylesheet" href="/static/admin.css">
    <script src="/static/admin.js"></script>
</head>
<body>
    <!-- Login Form (shown when auth is enabled and user is not logged in) -->
    <div id="loginContainer" class="login-container hidden">
        <h2 style="text-align: center; margin-bottom: 30px; color: #007AFF;">MCP Gateway Login</h2>
        <div id="loginError" class="error hidden"></div>
        <form id="loginForm" class="login-form">
            <div class="form-group">
                <label for="username">Username:</label>
                <input type="text" id="username" name="username" required>
            </div>
            <div class="form-group">
                <label for="password">Password:</label>
                <input type="password" id="password" name="password" required>
            </div>
            <button type="submit" class="btn">Login</button>
        </form>
        <p style="margin-top: 20px; text-align: center; color: #666; font-size: 14px;">
            Default credentials: admin / password
        </p>
    </div>

    <!-- Main Admin Panel -->
    <div id="adminPanel" class="container">
        <!-- Auth-specific elements -->
        <button id="logoutBtn" class="btn btn-secondary logout-btn hidden">Logout</button>
        
        <div class="header">
            <h1>MCP Gateway Admin Panel</h1>
            <div id="userInfo" class="user-info hidden"></div>
            <p id="adminDescription">Manage your Model Context Protocol upstream servers</p>
        </div>

        <!-- Auth-specific tabs -->
        <div id="authTabs" class="tabs hidden">
            <div class="tab" data-tab="servers">Upstream Servers</div>
            <div class="tab" data-tab="stats">Statistics</div>
            <div class="tab" data-tab="logs">Logs</div>
            <div class="tab" data-tab="tokens">Token Management</div>
        </div>

        <!-- Non-auth tabs (no token management) -->
        <div id="noAuthTabs" class="tabs hidden">
            <div class="tab" data-tab="servers">Upstream Servers</div>
            <div class="tab" data-tab="stats">Statistics</div>
            <div class="tab" data-tab="logs">Logs</div>
        </div>

        <!-- Token Management Tab (auth only) -->
        <div id="tokensTab" class="tab-content hidden">
            <h2>API Access Tokens</h2>
            <p style="margin-bottom: 20px; color: #86868b; font-size: 14px;">
                Create and manage API tokens for external access to the MCP Gateway. These tokens can be used by applications, scripts, or tools to authenticate with the gateway API.
                <br><strong>Note:</strong> Your current login session token is not shown here for security reasons.
            </p>
            <div id="tokenError" class="error hidden"></div>
            <div id="tokenSuccess" class="success hidden"></div>
            
            <div class="create-token-form">
                <h3>Create New API Token</h3>
                <form id="createTokenForm">
                    <div class="form-group">
                        <label for="tokenDescription">Description:</label>
                        <input type="text" id="tokenDescription" name="description" placeholder="e.g., VS Code Extension">
                    </div>
                    <div class="form-group">
                        <label for="tokenExpiry">Expires In (optional):</label>
                        <select id="tokenExpiry" name="expires_in" class="form-input">
                            <option value="14d">14 days</option>
                            <option value="30d">30 days</option>
                            <option value="90d">90 days</option>
                            <option value="1y">1 year</option>
                            <option value="">Never expires</option>
                        </select>
                    </div>
                    <button type="submit" class="btn">Create Token</button>
                </form>
            </div>

            <div id="tokensList" class="tokens-list"></div>
        </div>

        <!-- Statistics Tab -->
        <div id="statsTab" class="tab-content hidden">
            <h2>Gateway Statistics</h2>
            
            <!-- Core Statistics -->
            <div class="stats" id="statsContent">
                <div class="stat-card">
                    <div class="stat-number" id="totalServersStats">-</div>
                    <div class="stat-label">Total Servers</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="connectedServersStats">-</div>
                    <div class="stat-label">Connected Servers</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="totalToolsStats">-</div>
                    <div class="stat-label">Total Tools</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="totalResourcesStats">-</div>
                    <div class="stat-label">Total Resources</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="requestsProcessedStats">-</div>
                    <div class="stat-label">Requests Processed</div>
                </div>
            </div>

            <!-- User & Security Statistics -->
            <h3>User & Security</h3>
            <div class="stats">
                <div class="stat-card">
                    <div class="stat-number" id="activeTokensStats">-</div>
                    <div class="stat-label">Active Tokens</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="totalUsersStats">-</div>
                    <div class="stat-label">Total Users</div>
                </div>
            </div>

            <!-- Server Status Distribution -->
            <h3>Server Status Distribution</h3>
            <div class="stats" id="serverStatusStats">
                <!-- Dynamically populated -->
            </div>

            <!-- Server Type Distribution -->
            <h3>Server Type Distribution</h3>
            <div class="stats" id="serverTypeStats">
                <!-- Dynamically populated -->
            </div>

            <!-- Authentication Methods -->
            <h3>Authentication Methods</h3>
            <div class="stats" id="authMethodsStats">
                <!-- Dynamically populated -->
            </div>
            
            <div class="actions">
                <button class="btn btn-secondary" onclick="adminPanel.loadStats()">Refresh Statistics</button>
            </div>
            
            <div class="stats-details">
                <h3>Gateway Information</h3>
                <div class="info-grid">
                    <div class="info-item">
                        <span class="info-label">Gateway Name:</span>
                        <span class="info-value" id="gatewayName">-</span>
                    </div>
                    <div class="info-item">
                        <span class="info-label">Gateway Version:</span>
                        <span class="info-value" id="gatewayVersion">-</span>
                    </div>
                    <div class="info-item">
                        <span class="info-label">System Uptime:</span>
                        <span class="info-value" id="systemUptime">-</span>
                    </div>
                    <div class="info-item">
                        <span class="info-label">Last Database Update:</span>
                        <span class="info-value" id="lastDatabaseUpdate">-</span>
                    </div>
                    <div class="info-item">
                        <span class="info-label">Last Updated:</span>
                        <span class="info-value" id="lastUpdated">-</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Logs Tab -->
        <div id="logsTab" class="tab-content hidden">
            <h2>Logs</h2>
            <p style="margin-bottom: 20px; color: #86868b; font-size: 14px;">
                View logs for the gateway and individual servers. Request logs capture all HTTP requests, while server logs capture individual server events.
            </p>
            
            <div class="actions">
                <button class="btn btn-secondary" onclick="loadServerLogs()">Refresh Logs List</button>
                <div class="auto-refresh-toggle">
                    <span class="toggle-label">Auto-refresh logs</span>
                    <div class="toggle-switch" id="logsAutoRefreshToggle" onclick="toggleLogsAutoRefresh()">
                        <div class="toggle-slider"></div>
                    </div>
                </div>
                <span id="logsLastUpdateTime" class="last-update-time"></span>
            </div>
            
            <div class="logs-container">
                <div class="logs-list">
                    <h3>Gateway Logs</h3>
                    <div class="log-item" onclick="loadLog('request.log')">
                        <div class="log-name">request.log</div>
                        <div class="log-description">All HTTP requests with trace IDs and user information</div>
                    </div>
                    
                    <h3>Available Server Logs</h3>
                    <div id="logsListContainer">
                        <div class="loading">Loading logs...</div>
                    </div>
                </div>
                
                <div class="log-viewer">
                    <div class="log-viewer-header">
                        <h3 id="logViewerTitle">Select a log to view</h3>
                        <div class="log-controls">
                            <button class="btn btn-small" onclick="refreshCurrentLog()" id="refreshLogBtn" disabled>Refresh</button>
                            <button class="btn btn-small" onclick="downloadCurrentLog()" id="downloadLogBtn" disabled>Download</button>
                            <label>
                                <input type="checkbox" id="tailLogsCheckbox" onchange="toggleLogTail()"> 
                                Tail (last 100 lines)
                            </label>
                        </div>
                    </div>
                    <div class="log-content" id="logContent">
                        <div class="no-log-selected">Select a server log from the list to view its contents</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Servers Management Tab -->
        <div id="serversTab" class="tab-content hidden">
            <h2>Upstream Servers</h2>
            <div class="stats" id="stats">
                <div class="stat-card">
                    <div class="stat-number" id="totalServers">-</div>
                    <div class="stat-label">Total Servers</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="connectedServers">-</div>
                    <div class="stat-label">Connected</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="totalTools">-</div>
                    <div class="stat-label">Total Tools</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="totalResources">-</div>
                    <div class="stat-label">Total Resources</div>
                </div>
            </div>
            
            <div class="actions">
                <button class="btn" onclick="showAddServerModal()">Add Server</button>
                <button class="btn btn-secondary" onclick="refreshConnections()">Refresh Connections</button>
                <button class="btn btn-secondary" onclick="loadServers()">Reload</button>
                <div class="auto-refresh-toggle">
                    <span class="toggle-label">Auto-refresh</span>
                    <div class="toggle-switch" id="autoRefreshToggle" onclick="adminPanel.toggleAutoRefresh()">
                        <div class="toggle-slider"></div>
                    </div>
                </div>
                <span id="lastUpdateTime" class="last-update-time"></span>
            </div>
            
            <div class="servers-section">
                <div class="servers-header">
                    <h2>Upstream Servers</h2>
                    <span id="serverCount">0 servers</span>
                </div>
                <div class="servers-list" id="serversList">
                    <div class="loading">Loading servers...</div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Add/Edit Server Modal -->
    <div class="modal" id="serverModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title" id="modalTitle">Add Server</h3>
                <button class="close-btn" onclick="closeModal()">&times;</button>
            </div>
            <form id="serverForm">
                <div class="form-group">
                    <label class="form-label">Name *</label>
                    <input type="text" class="form-input" id="serverName" required>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">Type *</label>
                        <select class="form-input" id="serverType" required onchange="toggleServerFields()">
                            <option value="http">HTTP</option>
                            <option value="stdio">STDIO</option>
                            <option value="websocket">WebSocket</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Timeout</label>
                        <input type="text" class="form-input" id="serverTimeout" placeholder="30s" value="30s">
                    </div>
                </div>
                <div class="form-group" id="urlGroup">
                    <label class="form-label">URL *</label>
                    <input type="url" class="form-input" id="serverUrl" required>
                </div>
                <div class="form-group hidden" id="commandGroup">
                    <label class="form-label">Command *</label>
                    <input type="text" class="form-input" id="serverCommand" placeholder="e.g., npx @modelcontextprotocol/server-everything">
                    <div class="form-help">Enter the command to execute. Use spaces to separate command and arguments (e.g., "npx name --variable value")</div>
                </div>
                <div class="form-group">
                    <label class="form-label">Prefix</label>
                    <input type="text" class="form-input" id="serverPrefix" placeholder="Optional prefix for tools/resources">
                </div>
                <div class="form-group">
                    <label class="form-label">Description</label>
                    <input type="text" class="form-input" id="serverDescription" placeholder="Optional description">
                </div>
                
                <!-- Authentication Section (HTTP servers only) -->
                <div class="form-section" id="authSection">
                    <h4 class="form-section-title">HTTP Server Authentication</h4>
                    <div class="form-group">
                        <label class="form-label">Authentication Type</label>
                        <select class="form-input" id="authType" onchange="toggleAuthFields()">
                            <option value="">No Authentication</option>
                            <option value="bearer">Bearer Token</option>
                            <option value="basic">Basic Authentication</option>
                            <option value="api-key">API Key</option>
                        </select>
                    </div>
                    
                    <!-- Bearer Token Fields -->
                    <div class="auth-fields" id="bearerFields">
                        <div class="form-group">
                            <label class="form-label">Bearer Token</label>
                            <input type="password" class="form-input" id="bearerToken" placeholder="Enter bearer token">
                            <div class="form-help">This token will be sent as "Authorization: Bearer &lt;token&gt;"</div>
                        </div>
                    </div>
                    
                    <!-- Basic Auth Fields -->
                    <div class="auth-fields" id="basicFields">
                        <div class="form-row">
                            <div class="form-group">
                                <label class="form-label">Username</label>
                                <input type="text" class="form-input" id="basicUsername" placeholder="Username">
                            </div>
                            <div class="form-group">
                                <label class="form-label">Password</label>
                                <input type="password" class="form-input" id="basicPassword" placeholder="Password">
                            </div>
                        </div>
                        <div class="form-help">Credentials will be sent as "Authorization: Basic &lt;base64(username:password)&gt;"</div>
                    </div>
                    
                    <!-- API Key Fields -->
                    <div class="auth-fields" id="apiKeyFields">
                        <div class="form-group">
                            <label class="form-label">API Key</label>
                            <input type="password" class="form-input" id="apiKey" placeholder="Enter API key">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Header Name</label>
                            <input type="text" class="form-input" id="apiKeyHeader" placeholder="X-API-Key" value="X-API-Key">
                            <div class="form-help">Custom header name for the API key (default: X-API-Key)</div>
                        </div>
                    </div>
                </div>
                
                <div class="form-group">
                    <div class="checkbox-group">
                        <input type="checkbox" id="serverEnabled" checked>
                        <label for="serverEnabled">Enabled</label>
                    </div>
                </div>
                <div class="actions">
                    <button type="submit" class="btn">Save</button>
                    <button type="button" class="btn btn-secondary" onclick="closeModal()">Cancel</button>
                </div>
            </form>
        </div>
    </div>
    
</body>
</html>
